<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatle — Discover</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#071226; --panel:#0c1724; --muted:#9fb3c6; --text:#eaf6ff; --accent:#1ea7ff; --danger:#ff4b4b;
    --footer-height:76px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--footer-height) + 12px);}

  header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between}
  .brand{font-weight:800;font-size:20px;background:linear-gradient(90deg,#7de0ff,#5a8bff);-webkit-background-clip:text;color:transparent}
  .user{display:flex;align-items:center;gap:10px}
  .avatar{width:40px;height:40px;border-radius:50%;border:2px solid var(--accent);object-fit:cover}

  main{flex:1;padding:18px 16px 90px;overflow:auto}

  .panel{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
  
  .discover-status{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;justify-content:space-between;align-items:center}
  .status-left{display:flex;flex-direction:column;gap:6px}
  .status-title{font-weight:800;font-size:18px}
  .status-sub{color:var(--muted)}
  .timer{font-weight:700;color:var(--accent)}
  
  .toggle-switch{position:relative;display:inline-block;width:60px;height:30px}
  .toggle-switch input{opacity:0;width:0;height:0}
  .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#0b1117;transition:.4s;border-radius:34px}
  .toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:var(--accent);transition:.4s;border-radius:50%}
  input:checked + .toggle-slider{background-color:var(--accent)}
  input:checked + .toggle-slider:before{transform:translateX(30px)}

  .list{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:14px}
  .item{display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
  .item-header{display:flex;gap:12px;align-items:center}
  .item-photo{width:60px;height:60px;border-radius:50%;border:2px solid var(--accent);object-fit:cover}
  .item-meta{flex:1;display:flex;flex-direction:column}
  .item-name{font-weight:800;font-size:18px}
  .item-info{color:var(--muted);font-size:13px;margin-top:4px}
  .item-bio{color:var(--muted);font-size:14px;line-height:1.4}
  .item-footer{display:flex;justify-content:flex-end}
  
  .btn{padding:10px 16px;border-radius:10px;border:none;font-weight:600;cursor:pointer;transition:all 0.2s}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#0084ff);color:white}
  .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
  .btn-secondary{background:rgba(255,255,255,0.05);color:var(--text)}

  .empty{padding:18px;border-radius:12px;background:rgba(255,255,255,0.02);text-align:center;color:var(--muted)}

  footer{position:fixed;left:0;right:0;bottom:0;height:var(--footer-height);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02));border-top:1px solid rgba(255,255,255,0.03);z-index:9998}
  .nav{width:100%;max-width:980px;display:flex;gap:8px;padding:12px;justify-content:space-between}
  .tab{flex:1;padding:10px 6px;border-radius:12px;text-align:center;color:var(--muted);font-weight:600;cursor:pointer;-webkit-tap-highlight-color:transparent}
  .tab.active{color:white;background:linear-gradient(90deg,var(--accent),#0084ff);box-shadow:0 6px 18px rgba(30,167,255,0.12)}
</style>
</head>
<body>
<header>
  <div class="brand">Chatle</div>
  <div class="user">
    <img id="myAvatar" class="avatar" src="">
    <div id="myName" style="font-weight:700"></div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="discover-status">
      <div class="status-left">
        <div class="status-title">Discover Mode</div>
        <div class="status-sub">Turn on to let others find and chat with you</div>
        <div id="timerText" class="timer" style="display:none">30:00 remaining</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="discoverToggle">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:24px">
      <div style="font-size:18px;font-weight:800">Discover People</div>
      <div style="color:var(--muted)">Chat with people who have discover mode on</div>
    </div>

    <div id="discoverList" class="list" aria-live="polite"></div>
    <div id="loading" class="empty">Loading...</div>
  </section>
</main>

<footer>
  <div class="nav" role="navigation">
    <div id="navHome" class="tab" data-href="/chat.html">Home</div>
    <div id="navChats" class="tab" data-href="/chats.html">Chats</div>
    <div id="navProfile" class="tab" data-href="/profile.html">Profile</div>
    <div id="navDiscover" class="tab active" data-href="/discover.html">Discover</div>
  </div>
</footer>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const tg = Telegram.WebApp;
const initUser = tg.initDataUnsafe?.user || {};
const myId = initUser?.id?.toString();

const firebaseConfig = {
  apiKey: "AIzaSyCy2MOVaKyAiwZfiG93BWh1nTKZcnkMKOs",
  authDomain: "toolstr-f5308.firebaseapp.com",
  projectId: "toolstr-f5308",
  storageBucket: "toolstr-f5308.firebasestorage.app",
  messagingSenderId: "649384447951",
  appId: "1:649384447951:web:aede43e92b95a8aafbccba",
  measurementId: "G-58QST4E6R3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const myAvatar = document.getElementById('myAvatar');
const myName = document.getElementById('myName');
const discoverToggle = document.getElementById('discoverToggle');
const timerText = document.getElementById('timerText');
const discoverList = document.getElementById('discoverList');
const loadingEl = document.getElementById('loading');

const navHome = document.getElementById('navHome');
const navChats = document.getElementById('navChats');
const navProfile = document.getElementById('navProfile');
const navDiscover = document.getElementById('navDiscover');

myAvatar.src = initUser.photo_url || initUser.photoUrl || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
myName.textContent = initUser.first_name || initUser.username || 'You';

function navigateTo(href, el){
  setActiveNav(el);
  try { window.location.href = href; } catch(e){ tg.showPopup({message:"Navigation failed"}); }
}
function setActiveNav(activeEl){
  [navHome, navChats, navProfile, navDiscover].forEach(el => el.classList.toggle('active', el === activeEl));
}
navHome.addEventListener('click', ()=> navigateTo('/chat.html', navHome));
navChats.addEventListener('click', ()=> navigateTo('/chats.html', navChats));
navProfile.addEventListener('click', ()=> navigateTo('/profile.html', navProfile));
navDiscover.addEventListener('click', ()=> navigateTo('/discover.html', navDiscover));

function safeProfile(p){
  if (!p) return { nickname:"User", photoUrl:"", age:null, gender:'', country:'', countryName:'', bio:'' };
  return {
    nickname: p.nickname || "User",
    photoUrl: p.photoUrl || '',
    age: p.age || null,
    gender: p.gender || '',
    country: p.country || '',
    countryName: p.countryName || '',
    bio: p.bio || ''
  };
}

let discoverTimer = null;
let remainingTime = 0;

function updateDiscoverModeUI(enabled, endTime){
  discoverToggle.checked = enabled;
  if(enabled && endTime){
    const now = Date.now();
    const end = endTime.toMillis ? endTime.toMillis() : new Date(endTime).getTime();
    remainingTime = Math.max(0, end - now);
    
    if(remainingTime > 0){
      timerText.style.display = 'block';
      startTimer();
      tg.showPopup({
        title: 'Discover Mode ON',
        message: `Your profile is now discoverable for 30 minutes. You can turn it off anytime.`,
        buttons: [{type: 'ok'}]
      });
    } else {
      setDiscoverMode(false);
    }
  } else {
    timerText.style.display = 'none';
    if(discoverTimer){
      clearInterval(discoverTimer);
      discoverTimer = null;
    }
  }
}

function startTimer(){
  if(discoverTimer) clearInterval(discoverTimer);
  
  function updateDisplay(){
    const minutes = Math.floor(remainingTime / 60000);
    const seconds = Math.floor((remainingTime % 60000) / 1000);
    timerText.textContent = `${minutes}:${seconds.toString().padStart(2,'0')} remaining`;
    
    if(remainingTime <= 0){
      clearInterval(discoverTimer);
      setDiscoverMode(false);
      timerText.style.display = 'none';
      tg.showPopup({
        title: 'Discover Mode Ended',
        message: '30 minutes have passed. Your profile is no longer discoverable.',
        buttons: [{type: 'ok'}]
      });
    }
    remainingTime -= 1000;
  }
  
  updateDisplay();
  discoverTimer = setInterval(updateDisplay, 1000);
}

async function setDiscoverMode(enabled){
  try{
    const userRef = db.collection('users').doc(myId);
    if(enabled){
      const endTime = new Date(Date.now() + 30 * 60 * 1000);
      await userRef.set({
        discoverable: true,
        discoverableUntil: firebase.firestore.Timestamp.fromDate(endTime)
      }, { merge: true });
      updateDiscoverModeUI(true, endTime);
    } else {
      await userRef.set({
        discoverable: false,
        discoverableUntil: null
      }, { merge: true });
      updateDiscoverModeUI(false, null);
    }
  } catch(e){
    console.error("Discover mode error:", e);
    tg.showPopup({title:'Error', message:'Failed to update discover mode', buttons:[{type:'ok'}]});
  }
}

async function loadDiscoverableUsers(){
  loadingEl.style.display = 'block';
  discoverList.innerHTML = '';
  
  try{
    const now = firebase.firestore.Timestamp.now();
    const snapshot = await db.collection('users')
      .where('discoverable', '==', true)
      .where('discoverableUntil', '>', now)
      .get();
    
    if(snapshot.empty){
      discoverList.innerHTML = '<div class="empty">No discoverable users at the moment</div>';
      loadingEl.style.display = 'none';
      return;
    }
    
    const users = [];
    snapshot.forEach(doc => {
      if(doc.id === myId) return;
      const data = doc.data();
      const profile = safeProfile(data);
      profile.id = doc.id;
      users.push(profile);
    });
    
    users.forEach(user => {
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="item-header">
          <img class="item-photo" src="${user.photoUrl || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png'}" alt="profile">
          <div class="item-meta">
            <div class="item-name">${escapeHtml(user.nickname)}</div>
            <div class="item-info">
              ${user.age ? escapeHtml(user.age) + ' • ' : ''}
              ${escapeHtml(user.gender) || ''}
              ${user.countryName ? ' • ' + escapeHtml(user.countryName) : ''}
            </div>
          </div>
        </div>
        <div class="item-bio">${escapeHtml(user.bio || 'No bio')}</div>
        <div class="item-footer">
          <button class="btn btn-primary" data-id="${user.id}">Start Chat</button>
        </div>
      `;
      discoverList.appendChild(el);
    });
    
    discoverList.querySelectorAll('.btn-primary').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const partnerId = e.target.getAttribute('data-id');
        await startChatWithUser(partnerId);
      });
    });
    
    loadingEl.style.display = 'none';
  } catch(e){
    console.error("Load discoverable error:", e);
    loadingEl.textContent = 'Failed to load users';
  }
}

async function startChatWithUser(partnerId){
  try{
    const roomsSnap = await db.collection('rooms')
      .where('users', 'array-contains', myId)
      .get();
    
    let existingRoom = null;
    roomsSnap.forEach(doc => {
      const room = doc.data();
      if(room.users.includes(partnerId)){
        existingRoom = { id: doc.id, ...room };
      }
    });
    
    let roomId;
    if(existingRoom){
      roomId = existingRoom.id;
    } else {
      const roomRef = await db.collection('rooms').add({
        users: [myId, partnerId],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        friendRequests: {}
      });
      roomId = roomRef.id;
    }
    
    const url = `/special.html?room=${encodeURIComponent(roomId)}&partner=${encodeURIComponent(partnerId)}`;
    window.location.href = url;
    
  } catch(e){
    console.error("Start chat error:", e);
    tg.showPopup({title:'Error', message:'Failed to start chat', buttons:[{type:'ok'}]});
  }
}

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function initUserProfile(){
  const userRef = db.collection('users').doc(myId);
  const doc = await userRef.get();
  
  if(!doc.exists){
    await userRef.set({
      nickname: initUser.first_name || initUser.username || 'User',
      photoUrl: initUser.photo_url || initUser.photoUrl || '',
      discoverable: false,
      discoverableUntil: null
    }, { merge: true });
  } else {
    const data = doc.data();
    updateDiscoverModeUI(data.discoverable, data.discoverableUntil);
  }
}

discoverToggle.addEventListener('change', () => {
  setDiscoverMode(discoverToggle.checked);
});

initUserProfile();
loadDiscoverableUsers();
setInterval(loadDiscoverableUsers, 30000);

[navHome, navChats, navProfile, navDiscover].forEach(el => {
  el.addEventListener('click', () => {
    const href = el.getAttribute('data-href');
    try { window.location.href = href; } catch(e) { tg.showPopup({message:'Navigation failed'}); }
  });
});

console.log("discover.html loaded for", myId);
</script>
</body>
  </html>

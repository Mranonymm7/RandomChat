<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ToolsTR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); position: sticky; top: 0; z-index: 100; height: 60px; }
        .brand { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; background: linear-gradient(45deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .container { flex: 1; max-width: 500px; margin: 0 auto; width: 100%; padding: 20px; display: flex; flex-direction: column; }

        .screen { background: #111; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: right; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3); overflow: hidden; position: relative; }
        #historyDisplay { color: #888; font-size: 1.2rem; min-height: 24px; margin-bottom: 5px; overflow: hidden; white-space: nowrap; }
        #resultDisplay { color: #fff; font-size: 3.5rem; font-weight: 700; word-break: break-all; min-height: 50px; max-width: 100%; overflow: hidden; white-space: nowrap; transform-origin: right; }

        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }

        .btn { padding: 20px 0; border-radius: 15px; border: none; font-size: 1.5rem; font-weight: 600; cursor: pointer; transition: background 0.1s; color: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }

        .btn.num { background-color: #333; }
        .btn.num:active { background-color: #555; }

        .btn.op { background-color: #FF9500; font-size: 1.8rem; }
        .btn.op:active { background-color: #ffb74d; }

        .btn.op.eq { background-color: #4D96FF; }
        .btn.op.eq:active { background-color: #79acfa; }

        .btn.func { background-color: #A5A5A5; color: #000; }
        .btn.func:active { background-color: #c9c9c9; }

        .btn.zero { grid-column: span 2; text-align: left; padding-left: 30px; }
        .btn.zero span { margin-left: 10px; }

        #historyToggle { background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
        #historyToggle:hover { color: #4D96FF; }

        .history-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 200; display: none; justify-content: center; align-items: flex-start; padding-top: 60px; overflow-y: auto; }
        .history-content { background: #1a1a1a; width: 90%; max-width: 450px; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .history-content h3 { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2rem; color: #4D96FF; }
        #historyList { list-style: none; }
        #historyList li { padding: 10px 0; border-bottom: 1px dashed #222; cursor: pointer; transition: background 0.1s; }
        #historyList li:hover { background: #222; }

        .history-actions { display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; }
        .history-actions button { padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; width: 50%; transition: background 0.2s; }
        #closeHistory { background: #333; color: #fff; }
        #closeHistory:active { background: #555; }
        #clearHistory { background: #FF4D4D; color: #fff; }
        #clearHistory:active { background: #ff7d7d; }
    </style>
</head>
<body>
    <header>
        <div class="brand">ToolsTR</div>
        <button id="historyToggle" title="İşlem Geçmişi"><i class="fa-solid fa-clock-rotate-left"></i></button>
    </header>

    <div class="container">
        <div class="screen">
            <div id="historyDisplay"></div>
            <div id="resultDisplay">0</div>
        </div>

        <!-- === BUTTONS (EŞİTTİR TAŞINDI) === -->
        <div class="buttons">
            <button class="btn func" data-type="clear">AC</button>
            <button class="btn func" data-type="plus_minus">+/-</button>
            <button class="btn func" data-type="percent">%</button>
            <button class="btn op" data-type="operator" data-value="/"><i class="fa-solid fa-divide"></i></button>

            <button class="btn num" data-type="number" data-value="7">7</button>
            <button class="btn num" data-type="number" data-value="8">8</button>
            <button class="btn num" data-type="number" data-value="9">9</button>
            <button class="btn op" data-type="operator" data-value="*"><i class="fa-solid fa-xmark"></i></button>

            <button class="btn num" data-type="number" data-value="4">4</button>
            <button class="btn num" data-type="number" data-value="5">5</button>
            <button class="btn num" data-type="number" data-value="6">6</button>
            <button class="btn op" data-type="operator" data-value="-"><i class="fa-solid fa-minus"></i></button>

            <button class="btn num" data-type="number" data-value="1">1</button>
            <button class="btn num" data-type="number" data-value="2">2</button>
            <button class="btn num" data-type="number" data-value="3">3</button>
            <button class="btn op" data-type="operator" data-value="+"><i class="fa-solid fa-plus"></i></button>

            <button class="btn zero num" data-type="number" data-value="0">0</button>
            <button class="btn num" data-type="decimal" data-value=".">,</button>

            <!-- EŞİTTİR + TUŞUNUN ALTINDA -->
            <button class="btn op eq" data-type="equals" data-value="="><i class="fa-solid fa-equals"></i></button>
        </div>
    </div>

    <div class="history-panel" id="historyPanel">
        <div class="history-content">
            <h3>İşlem Geçmişi (Son 10)</h3>
            <ul id="historyList">
                <li style="color:#888; text-align:center;">Geçmiş boş.</li>
            </ul>
            <div class="history-actions">
                <button id="closeHistory"><i class="fa-solid fa-times"></i> Kapat</button>
                <button id="clearHistory"><i class="fa-solid fa-trash-can"></i> Temizle</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        try { 
            if (tg) { 
                tg.expand(); 
                tg.setHeaderColor('#000000'); 
                tg.setBackgroundColor('#000000'); 
                tg.BackButton.show();
                tg.BackButton.onClick(() => window.location.href = 'index.html');
            } 
        } catch(e){}

        const resultDisplay = document.getElementById('resultDisplay');
        const historyDisplay = document.getElementById('historyDisplay');
        const buttons = document.querySelectorAll('.btn');
        const historyToggleBtn = document.getElementById('historyToggle');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const closeHistoryBtn = document.getElementById('closeHistory');
        const clearHistoryBtn = document.getElementById('clearHistory');

        let currentInput = '0';
        let storedValue = null;
        let pendingOperation = null;
        let shouldResetInput = false;
        const MAX_HISTORY = 10;
        const HISTORY_KEY = 'calc_history';
        const MAX_DIGITS = 15;

        function getHistory() {
            const historyJSON = localStorage.getItem(HISTORY_KEY);
            return historyJSON ? JSON.parse(historyJSON) : [];
        }

        function saveHistory(expression, result) {
            const history = getHistory();
            const newEntry = { expression, result, timestamp: Date.now() };
            history.unshift(newEntry);
            if (history.length > MAX_HISTORY) history.pop();
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
        }

        function clearAllHistory() {
            if (confirm('Tüm işlem geçmişini silmek istediğinizden emin misiniz?')) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }

        function renderHistory() {
            const history = getHistory();
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<li style="color:#888; text-align:center;">Geçmiş boş.</li>';
                return;
            }
            history.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="history-expression">${item.expression} =</div><div class="history-result">${item.result}</div>`;
                li.addEventListener('click', () => recallHistoryResult(item.result));
                historyList.appendChild(li);
            });
        }

        function recallHistoryResult(result) {
            currentInput = result.toString();
            storedValue = null;
            pendingOperation = null;
            shouldResetInput = true;
            updateDisplay();
            historyPanel.style.display = 'none';
        }

        function updateDisplay() {
            const currentLength = currentInput.length;
            const displayValue = currentLength > 20 ? parseFloat(currentInput).toPrecision(10) : currentInput;
            resultDisplay.textContent = displayValue;

            if (currentLength > MAX_DIGITS) {
                const scaleFactor = Math.max(0.5, 1 - ((currentLength - MAX_DIGITS) * 0.05));
                resultDisplay.style.transform = `scaleX(${scaleFactor}) scaleY(${scaleFactor})`;
                resultDisplay.style.fontSize = '3.5rem';
            } else {
                resultDisplay.style.transform = 'scale(1)';
                resultDisplay.style.fontSize = '3.5rem';
            }

            historyDisplay.textContent = storedValue !== null && pendingOperation !== null 
                ? `${storedValue} ${pendingOperation}` 
                : '';
        }

        function calculate() {
            if (storedValue === null || pendingOperation === null) return parseFloat(currentInput);

            const num1 = parseFloat(storedValue);
            const num2 = parseFloat(currentInput);
            let result = 0;

            try {
                switch (pendingOperation) {
                    case '+': result = num1 + num2; break;
                    case '-': result = num1 - num2; break;
                    case '*': result = num1 * num2; break;
                    case '/': 
                        if (num2 === 0) throw new Error("Sıfıra bölme hatası");
                        result = num1 / num2; 
                        break;
                }
            } catch {
                return 'HATA';
            }

            return parseFloat(result.toFixed(14)).toString();
        }

        function handleNumber(value) {
            if (currentInput === '0' || shouldResetInput || currentInput === 'HATA') {
                currentInput = value;
                shouldResetInput = false;
            } else if (currentInput.length < 25) {
                currentInput += value;
            }
            updateDisplay();
        }

        function handleDecimal() {
            if (shouldResetInput) {
                currentInput = '0.';
                shouldResetInput = false;
            } else if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateDisplay();
        }

        function handleOperator(nextOperation) {
            if (currentInput === 'HATA') return;

            if (storedValue === null) {
                storedValue = currentInput;
            } else if (!shouldResetInput) {
                const calculatedResult = calculate();

                if (calculatedResult === 'HATA') {
                    currentInput = 'HATA';
                    storedValue = null;
                    pendingOperation = null;
                    updateDisplay();
                    return;
                }

                currentInput = calculatedResult;
                storedValue = calculatedResult;
                updateDisplay();
            }

            pendingOperation = nextOperation;
            shouldResetInput = true;
        }

        function handleEquals() {
            if (currentInput === 'HATA' || storedValue === null) return;

            const calculatedResult = calculate();
            const expression = `${storedValue} ${pendingOperation} ${currentInput}`;

            if (calculatedResult === 'HATA') {
                currentInput = 'HATA';
                storedValue = null;
                pendingOperation = null;
                updateDisplay();
                return;
            }

            saveHistory(expression, calculatedResult);

            currentInput = calculatedResult;
            storedValue = null;
            pendingOperation = null;
            shouldResetInput = true;
            updateDisplay();
        }

        function handleFunction(type) {
            if (currentInput === 'HATA') {
                currentInput = '0';
                storedValue = null;
                pendingOperation = null;
                updateDisplay();
                return;
            }
            
            let num = parseFloat(currentInput);

            switch (type) {
                case 'clear':
                    currentInput = '0';
                    storedValue = null;
                    pendingOperation = null;
                    shouldResetInput = false;
                    break;
                case 'plus_minus':
                    currentInput = (num * -1).toString();
                    break;
                case 'percent':
                    currentInput = (num / 100).toString();
                    shouldResetInput = true;
                    break;
            }
            updateDisplay();
        }

        buttons.forEach(button => {
            button.addEventListener('click', e => {
                const type = e.currentTarget.dataset.type;
                const value = e.currentTarget.dataset.value;

                switch (type) {
                    case 'number': handleNumber(value); break;
                    case 'decimal': handleDecimal(); break;
                    case 'operator': handleOperator(value); break;
                    case 'equals': handleEquals(); break;
                    case 'clear':
                    case 'plus_minus':
                    case 'percent': handleFunction(type); break;
                }
            });
        });

        historyToggleBtn.addEventListener('click', () => {
            renderHistory();
            historyPanel.style.display = 'flex';
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyPanel.style.display = 'none';
        });

        clearHistoryBtn.addEventListener('click', clearAllHistory);
        
        historyPanel.addEventListener('click', e => {
            if (e.target === historyPanel) historyPanel.style.display = 'none';
        });

        updateDisplay();
        renderHistory();
    </script>
</body>
  </html> 

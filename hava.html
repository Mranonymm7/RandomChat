<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ToolsTR - Hava Durumu</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- Ana Tema Ayarları --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header ve Başlık --- */
        header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 20px;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .brand {
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: -0.5px;
            background: linear-gradient(45deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- İçerik Alanı --- */
        .container {
            padding: 25px 20px;
            flex: 1;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Arama ve Konum Alanı --- */
        .search-area {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .search-input {
            flex-grow: 1;
            padding: 12px 15px;
            background-color: #111;
            border: 2px solid #222;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .search-input:focus {
            border-color: #fff;
        }

        .btn-icon {
            padding: 12px;
            background-color: #fff;
            color: #000;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s;
            flex-shrink: 0;
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        /* --- Yükleniyor ve Hata Mesajı --- */
        #loading, #error-message {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }
        
        #loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Ana Hava Durumu Kartı --- */
        #weather-results {
            display: none; /* Başlangıçta gizli */
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
        }

        .current-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .location-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .temp-main {
            font-size: 4rem;
            font-weight: 200;
            line-height: 1;
        }

        .description {
            font-size: 1.1rem;
            color: #aaa;
            margin-top: 5px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .detail-item {
            background: #000;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
            text-align: left;
            border: 1px solid #222;
        }

        .detail-item i {
            color: #fff;
            margin-right: 8px;
        }

        .detail-item span {
            color: #888;
        }

        /* --- Saatlik/Günlük Tahminler --- */
        .section-title {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .forecast-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
        }
        
        .hourly-item, .daily-item {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            min-width: 90px;
            flex-shrink: 0;
        }

        .hourly-item i {
            font-size: 1.5rem;
            margin: 5px 0;
        }

        .hourly-time, .daily-day {
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .hourly-temp, .daily-temp {
            font-size: 1.1rem;
            font-weight: 800;
            margin-top: 5px;
            color: #fff;
        }

        .daily-high-low {
            font-size: 0.8rem;
            color: #888;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">ToolsTR</div>
    </header>

    <div class="container">
        
        <div class="search-area">
            <input type="text" id="cityInput" class="search-input" placeholder="Şehir veya Konum Adı Girin...">
            <button class="btn-icon" id="searchBtn" title="Ara">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
            <button class="btn-icon" id="locationBtn" title="Mevcut Konum">
                <i class="fa-solid fa-location-crosshairs"></i>
            </button>
        </div>

        <div id="loading"><i class="fa-solid fa-spinner"></i> Hava durumu bilgisi yükleniyor...</div>
        <div id="error-message" style="display: none;"></div>

        <div id="weather-results">
            
            <div class="current-card">
                <div class="location-title" id="currentLocation"></div>
                <div class="temp-main" id="currentTemp"></div>
                <div class="description" id="currentDesc"></div>

                <div class="details-grid">
                    <div class="detail-item"><i class="fa-solid fa-wind"></i> Rüzgar: <span id="windSpeed"></span></div>
                    <div class="detail-item"><i class="fa-solid fa-droplet"></i> Nem: <span id="humidity"></span></div>
                    <div class="detail-item"><i class="fa-solid fa-eye"></i> Görüş: <span id="visibility"></span></div>
                    <div class="detail-item"><i class="fa-solid fa-gauge-high"></i> Basınç: <span id="pressure"></span></div>
                </div>
            </div>

            <div class="section-title">Sonraki Saatler</div>
            <div class="forecast-container" id="hourlyForecast">
                </div>

            <div class="section-title">7 Günlük Tahmin</div>
            <div class="forecast-container" id="dailyForecast">
                </div>

        </div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');

        // Geri Butonu
        tg.BackButton.show();
        tg.BackButton.onClick(() => window.location.href = 'index.html');

        // --- Sabitler ve API Anahtarı ---
        const API_KEY = 'f2b97b682bb652700e21ab0332b67975';
        const BASE_URL = 'https://api.openweathermap.org/data/2.5/onecall';
        const GEO_URL = 'https://api.openweathermap.org/geo/1.0/direct';
        const LANG = 'tr';
        const UNITS = 'metric'; // Celsius

        // --- DOM Elemanları ---
        const cityInput = document.getElementById('cityInput');
        const searchBtn = document.getElementById('searchBtn');
        const locationBtn = document.getElementById('locationBtn');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const resultsEl = document.getElementById('weather-results');
        const hourlyForecastEl = document.getElementById('hourlyForecast');
        const dailyForecastEl = document.getElementById('dailyForecast');

        // --- Yardımcı Fonksiyonlar ---

        // Unix zaman damgasını HH:MM formatına çevirir
        const formatTime = (dt, timezone) => new Date((dt + timezone) * 1000).toISOString().substr(11, 5);

        // Unix zaman damgasını gün adına çevirir
        const formatDay = (dt) => new Date(dt * 1000).toLocaleDateString('tr-TR', { weekday: 'short' });

        // İkon kodu ile FontAwesome ikonu eşleştirme
        const getWeatherIcon = (iconCode) => {
            if (iconCode.includes('d')) { // Gündüz ikonları
                if (iconCode.includes('01')) return 'fa-solid fa-sun'; // Açık
                if (iconCode.includes('02') || iconCode.includes('03')) return 'fa-solid fa-cloud-sun'; // Parçalı Bulutlu
                if (iconCode.includes('04')) return 'fa-solid fa-cloud'; // Bulutlu
                if (iconCode.includes('09') || iconCode.includes('10')) return 'fa-solid fa-cloud-showers-heavy'; // Yağmur
                if (iconCode.includes('11')) return 'fa-solid fa-bolt'; // Fırtına
                if (iconCode.includes('13')) return 'fa-solid fa-snowflake'; // Kar
                if (iconCode.includes('50')) return 'fa-solid fa-smog'; // Sis
            } else { // Gece ikonları
                if (iconCode.includes('01')) return 'fa-solid fa-moon'; // Açık
                if (iconCode.includes('02') || iconCode.includes('03')) return 'fa-solid fa-cloud-moon'; 
                return 'fa-solid fa-cloud'; // Diğerleri
            }
            return 'fa-solid fa-question';
        };
        
        // --- Durum Yönetimi ---

        const setLoading = (show) => {
            loadingEl.style.display = show ? 'block' : 'none';
            errorEl.style.display = 'none';
            resultsEl.style.display = 'none';
        };

        const showError = (message) => {
            setLoading(false);
            errorEl.innerText = `Hata: ${message}`;
            errorEl.style.display = 'block';
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
        };
        
        // --- Hava Durumu Çekme (Lat/Lon ile) ---
        async function fetchWeather(lat, lon, locationName = 'Mevcut Konum') {
            setLoading(true);

            const url = `${BASE_URL}?lat=${lat}&lon=${lon}&units=${UNITS}&lang=${LANG}&appid=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('API bağlantı hatası.');
                const data = await response.json();
                
                displayWeather(data, locationName);
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                showError('Hava durumu bilgisi çekilemedi. Lütfen tekrar deneyin.');
                console.error('Weather fetch error:', error);
            }
        }
        
        // --- Konumdan Çekme (Şehir Adı ile) ---
        async function fetchLocationAndWeather(cityName) {
            setLoading(true);

            // 1. Şehir adını Lat/Lon'a çevir
            const geoUrl = `${GEO_URL}?q=${cityName}&limit=1&appid=${API_KEY}`;

            try {
                const geoResponse = await fetch(geoUrl);
                const geoData = await geoResponse.json();

                if (!geoResponse.ok || geoData.length === 0) {
                    throw new Error('Konum bulunamadı.');
                }
                
                const { lat, lon, name, country } = geoData[0];
                const locationName = `${name}, ${country}`;

                // 2. Lat/Lon ile hava durumunu çek
                await fetchWeather(lat, lon, locationName);

            } catch (error) {
                showError(error.message === 'Konum bulunamadı.' 
                    ? 'Aradığınız konum bulunamadı. Lütfen şehir adını kontrol edin.' 
                    : 'Konum arama hatası. Lütfen tekrar deneyin.'
                );
                console.error('Geolocation error:', error);
            }
        }

        // --- Konumu Otomatik Çekme ---
        function getCurrentLocation() {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            setLoading(true);
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        // Ters coğrafi kodlama ile şehir adını bulmaya gerek kalmadan API'yi çağırıyoruz
                        fetchWeather(latitude, longitude);
                    },
                    (error) => {
                        showError('Konum izni reddedildi veya alınamadı. Lütfen manuel arama yapın.');
                        console.error('Geolocation error:', error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showError('Cihazınız konum özelliğini desteklemiyor.');
            }
        }

        // --- Sonuçları Ekrana Basma (Render) ---
        function displayWeather(data, locationName) {
            resultsEl.style.display = 'flex';
            setLoading(false);
            
            const current = data.current;
            const timezoneOffset = data.timezone_offset;

            // Anlık Durum
            document.getElementById('currentLocation').innerText = locationName;
            document.getElementById('currentTemp').innerHTML = `${Math.round(current.temp)}°C`;
            document.getElementById('currentDesc').innerText = current.weather[0].description.toUpperCase();

            document.getElementById('windSpeed').innerText = `${current.wind_speed.toFixed(1)} m/s`;
            document.getElementById('humidity').innerText = `${current.humidity}%`;
            document.getElementById('visibility').innerText = `${(current.visibility / 1000).toFixed(1)} km`;
            document.getElementById('pressure').innerText = `${current.pressure} hPa`;

            // Saatlik Tahmin (Sonraki 24 saat)
            hourlyForecastEl.innerHTML = data.hourly.slice(1, 25).map(hour => `
                <div class="hourly-item">
                    <div class="hourly-time">${formatTime(hour.dt, timezoneOffset)}</div>
                    <i class="${getWeatherIcon(hour.weather[0].icon)}"></i>
                    <div class="hourly-temp">${Math.round(hour.temp)}°C</div>
                    <div style="font-size: 0.7rem; color: #aaa;">%${hour.pop ? Math.round(hour.pop * 100) : 0}</div>
                </div>
            `).join('');

            // Günlük Tahmin (Sonraki 7 gün)
            dailyForecastEl.innerHTML = data.daily.slice(1, 8).map(day => `
                <div class="daily-item">
                    <div class="daily-day">${formatDay(day.dt)}</div>
                    <i class="${getWeatherIcon(day.weather[0].icon)}"></i>
                    <div class="daily-temp">${Math.round(day.temp.day)}°C</div>
                    <div class="daily-high-low">${Math.round(day.temp.max)}/${Math.round(day.temp.min)}°C</div>
                </div>
            `).join('');
        }

        // --- Olay Dinleyicileri ---
        
        // Ara Butonu
        searchBtn.addEventListener('click', () => {
            const city = cityInput.value.trim();
            if (city) {
                fetchLocationAndWeather(city);
                cityInput.blur(); // Klavyeyi kapat
            } else {
                 showError('Lütfen bir şehir veya konum adı girin.');
            }
        });

        // Konum Butonu
        locationBtn.addEventListener('click', getCurrentLocation);
        
        // Enter tuşu ile arama
        cityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchBtn.click();
            }
        });

        // --- Uygulama Başlangıcı ---
        // Uygulama açıldığında otomatik olarak mevcut konumu çek
        getCurrentLocation();

    </script>
</body>
</html>

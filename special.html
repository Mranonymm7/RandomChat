<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatle — Chat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root {
    --bg: #051020;
    --panel: #0d1624;
    --text: #edf4ff;
    --muted: #99b3c7;
    --accent: #1ea7ff;
    --danger: #ff4b4b;
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }
  header { padding:14px 18px; background:var(--panel); display:flex; align-items:center; gap:14px; border-bottom:1px solid rgba(255,255,255,0.04); position:relative; }
  .partner-photo { width:64px; height:64px; border-radius:50%; border:3px solid var(--accent); object-fit:cover; }
  .partner-meta { display:flex; flex-direction:column; gap:4px; }
  .partner-name { font-weight:800; font-size:18px; }
  .partner-details { color:var(--muted); font-size:13px; }
  .partner-bio { color:var(--muted); font-size:13px; opacity:0.95; margin-top:6px; max-width:540px; }
  .friend-btn { position:absolute; right:16px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.04); border:none; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; }

  main { display:flex; flex-direction:column; flex:1; overflow:hidden; }
  #messages { flex:1; padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
  .date-sep { text-align:center; opacity:0.6; font-size:13px; margin:6px 0; }
  .bubble { max-width:78%; padding:12px 14px; border-radius:14px; line-height:1.45; word-break:break-word; }
  .mine { align-self:flex-end; background:linear-gradient(90deg,var(--accent),#0098f0); }
  .other { align-self:flex-start; background:#0b1117; }
  .bubble .time { display:block; font-size:11px; color:var(--muted); margin-top:8px; text-align:right; }

  .composer { display:flex; gap:10px; padding:12px; background:var(--panel); border-top:1px solid rgba(255,255,255,0.03); align-items:center; }
  .input { flex:1; padding:12px; border-radius:12px; background:#06101a; border:1px solid rgba(255,255,255,0.02); color:var(--text); font-size:15px; }
  .send-btn { background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }

  .end-wrap { padding:14px; background:transparent; }
  .end-btn { width:100%; padding:14px; border-radius:16px; background:var(--danger); color:white; border:none; font-weight:800; cursor:pointer; box-shadow:0 8px 24px rgba(255,80,80,0.16); font-size:16px; }

  /* small screens tweak */
  @media (max-width:520px) {
    .partner-bio { max-width:260px; font-size:12px; }
    .partner-name { font-size:16px; }
    .bubble { font-size:15px; }
  }
</style>
</head>
<body>
<header>
  <img id="partnerPhoto" class="partner-photo" src="" alt="Partner photo">
  <div class="partner-meta">
    <div id="partnerName" class="partner-name">User</div>
    <div id="partnerDetails" class="partner-details"></div>
    <div id="partnerBio" class="partner-bio"></div>
  </div>
  <button id="friendBtn" class="friend-btn">+</button>
</header>

<main>
  <div id="messages"></div>

  <div class="composer">
    <input id="messageInput" class="input" placeholder="Type a message..." autocomplete="off" />
    <button id="sendBtn" class="send-btn">Send</button>
  </div>

  <div class="end-wrap">
    <button id="endBtn" class="end-btn">End Chat</button>
  </div>
</main>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const tg = Telegram.WebApp;

// ========== FIREBASE config (your project) ==========
const firebaseConfig = {
  apiKey: "AIzaSyCy2MOVaKyAiwZfiG93BWh1nTKZcnkMKOs",
  authDomain: "toolstr-f5308.firebaseapp.com",
  projectId: "toolstr-f5308",
  storageBucket: "toolstr-f5308.firebasestorage.app",
  messagingSenderId: "649384447951",
  appId: "1:649384447951:web:aede43e92b95a8aafbccba",
  measurementId: "G-58QST4E6R3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// ====================================================

// Query params
const params = new URLSearchParams(location.search);
const roomId = params.get('room');
const partnerId = params.get('partner');

if (!roomId || !partnerId) {
  tg.showPopup({ message: "Missing room or partner parameter" });
  throw new Error("Missing room or partner parameter");
}

const roomRef = db.doc(`rooms/${roomId}`);
const messagesRef = db.collection(`rooms/${roomId}/messages`);

const myId = Telegram.WebApp.initDataUnsafe?.user?.id?.toString();
let myProfile = null;
tg.CloudStorage.getItem('profile', (err, saved) => {
  if (saved) {
    try { myProfile = JSON.parse(saved); } catch(e){ myProfile = null; }
  }
});

// DOM
const partnerPhoto = document.getElementById('partnerPhoto');
const partnerName = document.getElementById('partnerName');
const partnerDetails = document.getElementById('partnerDetails');
const partnerBio = document.getElementById('partnerBio');
const friendBtn = document.getElementById('friendBtn');
const messagesDiv = document.getElementById('messages');
const input = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const endBtn = document.getElementById('endBtn');

// safe profile
function safeProfile(p) {
  if (!p) return { nickname: 'User', photoUrl: '', age: null, gender: '', country: '', countryName: '', bio: '' };
  return {
    nickname: p.nickname || 'User',
    photoUrl: p.photoUrl || '',
    age: p.age || null,
    gender: p.gender || '',
    country: p.country || '',
    countryName: p.countryName || '',
    bio: p.bio || ''
  };
}

// Render messages (called when messages snapshot updates)
function renderMessages(messageDocs) {
  messagesDiv.innerHTML = '';
  let lastDate = '';
  messageDocs.forEach(doc => {
    const m = doc.data();
    const ts = m.timestamp && m.timestamp.toDate ? m.timestamp.toDate() : new Date();
    const dateStr = ts.toLocaleDateString();
    if (dateStr !== lastDate) {
      const sep = document.createElement('div');
      sep.className = 'date-sep';
      sep.textContent = dateStr;
      messagesDiv.appendChild(sep);
      lastDate = dateStr;
    }

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (m.sender === myId ? 'mine' : 'other');
    bubble.textContent = m.text || '';
    const time = document.createElement('span');
    time.className = 'time';
    time.textContent = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    bubble.appendChild(time);
    messagesDiv.appendChild(bubble);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Listen to room (profile, active state, friend requests)
const roomUnsub = roomRef.onSnapshot(snap => {
  if (!snap.exists) {
    tg.showPopup({ message: "Chat ended" });
    window.location.href = "/chat.html";
    return;
  }
  const data = snap.data();

  // If explicitly ended, both sides should exit.
  if (data.active === false) {
    tg.showPopup({ message: "Chat ended" });
    window.location.href = "/chat.html";
    return;
  }

  // Partner profile may arrive later; we pull it defensively
  const partnerRaw = (data.profiles || {})[partnerId] || {};
  const partner = safeProfile(partnerRaw);

  partnerPhoto.src = partner.photoUrl || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
  partnerName.textContent = partner.nickname;
  const genderSymbol = partner.gender === 'male' ? '♂' : partner.gender === 'female' ? '♀' : (partner.gender ? '⚧' : '');
  partnerDetails.textContent = `${partner.age ? (partner.age + ' • ') : ''}${genderSymbol} ${partner.countryName || partner.country || ''}`.trim();
  partnerBio.textContent = partner.bio || '';

  // friend button ui
  const req = data.friendRequests || {};
  if (req[myId] && req[partnerId]) { friendBtn.textContent = '✓'; friendBtn.disabled = true; }
  else if (req[myId]) { friendBtn.textContent = '✔'; friendBtn.disabled = false; }
  else if (req[partnerId]) { friendBtn.textContent = '?'; friendBtn.disabled = false; tg.showPopup({ message: "Friend request received" }); }
  else { friendBtn.textContent = '+'; friendBtn.disabled = false; }
}, err => {
  console.error("room onSnapshot error:", err);
  tg.showPopup({ message: "Connection error" });
});

// Messages listener (subcollection)
const messagesUnsub = messagesRef.orderBy('timestamp', 'asc').onSnapshot(snapshot => {
  renderMessages(snapshot.docs);
}, err => {
  console.error("messages onSnapshot error:", err);
  tg.showPopup({ message: "Messages listener error" });
});

// Send message - add a document to messages subcollection (robust)
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  input.disabled = true;
  sendBtn.disabled = true;

  try {
    await messagesRef.add({
      sender: myId,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value = '';
  } catch (e) {
    console.error("sendMessage error:", e);
    tg.showPopup({ message: "Failed to send message" });
  } finally {
    input.disabled = false;
    sendBtn.disabled = false;
  }
}
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

// Friend request
friendBtn.addEventListener('click', async () => {
  try {
    await roomRef.update({ [`friendRequests.${myId}`]: true });
    tg.showPopup({ message: "Friend request sent" });
  } catch (e) {
    console.error("friend request error", e);
    tg.showPopup({ message: "Failed to send friend request" });
  }
});

// End chat — set active:false + endedBy; both clients react to this update
endBtn.addEventListener('click', async () => {
  const confirmEnd = confirm("End this chat for both sides?");
  if (!confirmEnd) return;

  try {
    await roomRef.update({
      active: false,
      endedBy: myId,
      endedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // local immediate redirect; other side will be redirected by its snapshot listener
    tg.showPopup({ message: "Chat ended" });
    window.location.href = "/chat.html";
  } catch (e) {
    console.error("end chat error", e);
    tg.showPopup({ message: "Failed to end chat" });
  }
});

// Clean up on unload
window.addEventListener('beforeunload', () => {
  try { roomUnsub && roomUnsub(); } catch(e){}
  try { messagesUnsub && messagesUnsub(); } catch(e){}
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatle</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #000000);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #111111);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #b1b1b1);
            --tg-button: var(--tg-theme-button-color, #0088cc);
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            background: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 420px;
            padding: 32px 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 52px;
            font-weight: 900;
            background: linear-gradient(135deg, #00d4ff, #3366ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 10px;
            letter-spacing: -2px;
        }

        .subtitle {
            font-size: 17px;
            opacity: 0.8;
            margin: 0;
            font-weight: 500;
        }

        .profile-card {
            background: var(--tg-secondary);
            border-radius: 28px;
            padding: 28px 24px;
            text-align: center;
            margin-bottom: 36px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
        }

        .avatar {
            width: 104px;
            height: 104px;
            border-radius: 50%;
            border: 5px solid var(--tg-button);
            box-shadow: 0 0 40px rgba(0, 136, 204, 0.5);
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 26px;
            font-weight: 700;
            margin: 0 0 8px;
        }

        .info {
            font-size: 16px;
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 15px;
            font-weight: 500;
            opacity: 0.85;
        }

        input, select, textarea {
            width: 100%;
            padding: 17px 18px;
            background: rgba(255, 255, 255, 0.07);
            border: 1.5px solid rgba(255, 255, 255, 0.12);
            border-radius: 18px;
            color: var(--tg-text);
            font-size: 17px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        input::placeholder, textarea::placeholder {
            color: var(--tg-hint);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--tg-button);
            box-shadow: 0 0 0 4px rgba(0, 136, 204, 0.25);
        }

        textarea {
            min-height: 110px;
            resize: none;
        }

        .country-input {
            position: relative;
        }

        #country-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--tg-secondary);
            border: 1.5px solid rgba(255, 255, 255, 0.12);
            border-radius: 18px;
            max-height: 340px;
            overflow-y: auto;
            z-index: 10;
            margin-top: 8px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .country-item {
            padding: 16px 18px;
            cursor: pointer;
            transition: background 0.25s;
            font-size: 17px;
        }

        .country-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        if (!window.Telegram?.WebApp) {
            document.body.innerHTML = `<div style="text-align:center;padding:80px;color:#ff4444;"><h1>Access Denied</h1><p>Open from Telegram</p></div>`;
            throw new Error("Not in Telegram");
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const tg = Telegram.WebApp;
        const user = tg.initDataUnsafe.user;

        const displayName = user.username ? `@\( {user.username}` : user.first_name + (user.last_name ? ` \){user.last_name}` : '');
        const photoUrl = user.photo_url || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';

        const countries = [
            {name: "Afghanistan", code: "AF"},
            {name: "Albania", code: "AL"},
            {name: "Algeria", code: "DZ"},
            {name: "Andorra", code: "AD"},
            {name: "Angola", code: "AO"},
            {name: "Argentina", code: "AR"},
            {name: "Armenia", code: "AM"},
            {name: "Australia", code: "AU"},
            {name: "Austria", code: "AT"},
            {name: "Azerbaijan", code: "AZ"},
            {name: "Bahamas", code: "BS"},
            {name: "Bahrain", code: "BH"},
            {name: "Bangladesh", code: "BD"},
            {name: "Barbados", code: "BB"},
            {name: "Belarus", code: "BY"},
            {name: "Belgium", code: "BE"},
            {name: "Belize", code: "BZ"},
            {name: "Benin", code: "BJ"},
            {name: "Bhutan", code: "BT"},
            {name: "Bolivia", code: "BO"},
            {name: "Bosnia and Herzegovina", code: "BA"},
            {name: "Botswana", code: "BW"},
            {name: "Brazil", code: "BR"},
            {name: "Brunei", code: "BN"},
            {name: "Bulgaria", code: "BG"},
            {name: "Burkina Faso", code: "BF"},
            {name: "Burundi", code: "BI"},
            {name: "Cambodia", code: "KH"},
            {name: "Cameroon", code: "CM"},
            {name: "Canada", code: "CA"},
            {name: "Cape Verde", code: "CV"},
            {name: "Chad", code: "TD"},
            {name: "Chile", code: "CL"},
            {name: "China", code: "CN"},
            {name: "Colombia", code: "CO"},
            {name: "Comoros", code: "KM"},
            {name: "Congo (Dem. Rep.)", code: "CD"},
            {name: "Congo (Rep.)", code: "CG"},
            {name: "Costa Rica", code: "CR"},
            {name: "Croatia", code: "HR"},
            {name: "Cuba", code: "CU"},
            {name: "Cyprus", code: "CY"},
            {name: "Czechia", code: "CZ"},
            {name: "Denmark", code: "DK"},
            {name: "Djibouti", code: "DJ"},
            {name: "Dominica", code: "DM"},
            {name: "Dominican Republic", code: "DO"},
            {name: "Ecuador", code: "EC"},
            {name: "Egypt", code: "EG"},
            {name: "El Salvador", code: "SV"},
            {name: "Estonia", code: "EE"},
            {name: "Ethiopia", code: "ET"},
            {name: "Fiji", code: "FJ"},
            {name: "Finland", code: "FI"},
            {name: "France", code: "FR"},
            {name: "Gabon", code: "GA"},
            {name: "Gambia", code: "GM"},
            {name: "Georgia", code: "GE"},
            {name: "Germany", code: "DE"},
            {name: "Ghana", code: "GH"},
            {name: "Greece", code: "GR"},
            {name: "Grenada", code: "GD"},
            {name: "Guatemala", code: "GT"},
            {name: "Guinea", code: "GN"},
            {name: "Guyana", code: "GY"},
            {name: "Haiti", code: "HT"},
            {name: "Honduras", code: "HN"},
            {name: "Hungary", code: "HU"},
            {name: "Iceland", code: "IS"},
            {name: "India", code: "IN"},
            {name: "Indonesia", code: "ID"},
            {name: "Iran", code: "IR"},
            {name: "Iraq", code: "IQ"},
            {name: "Ireland", code: "IE"},
            {name: "Israel", code: "IL"},
            {name: "Italy", code: "IT"},
            {name: "Jamaica", code: "JM"},
            {name: "Japan", code: "JP"},
            {name: "Jordan", code: "JO"},
            {name: "Kazakhstan", code: "KZ"},
            {name: "Kenya", code: "KE"},
            {name: "Kiribati", code: "KI"},
            {name: "Kuwait", code: "KW"},
            {name: "Kyrgyzstan", code: "KG"},
            {name: "Laos", code: "LA"},
            {name: "Latvia", code: "LV"},
            {name: "Lebanon", code: "LB"},
            {name: "Lesotho", code: "LS"},
            {name: "Liberia", code: "LR"},
            {name: "Libya", code: "LY"},
            {name: "Liechtenstein", code: "LI"},
            {name: "Lithuania", code: "LT"},
            {name: "Luxembourg", code: "LU"},
            {name: "Madagascar", code: "MG"},
            {name: "Malawi", code: "MW"},
            {name: "Malaysia", code: "MY"},
            {name: "Maldives", code: "MV"},
            {name: "Mali", code: "ML"},
            {name: "Malta", code: "MT"},
            {name: "Mexico", code: "MX"},
            {name: "Monaco", code: "MC"},
            {name: "Mongolia", code: "MN"},
            {name: "Montenegro", code: "ME"},
            {name: "Morocco", code: "MA"},
            {name: "Mozambique", code: "MZ"},
            {name: "Myanmar", code: "MM"},
            {name: "Namibia", code: "NA"},
            {name: "Nauru", code: "NR"},
            {name: "Nepal", code: "NP"},
            {name: "Netherlands", code: "NL"},
            {name: "New Zealand", code: "NZ"},
            {name: "Nicaragua", code: "NI"},
            {name: "Niger", code: "NE"},
            {name: "Nigeria", code: "NG"},
            {name: "North Korea", code: "KP"},
            {name: "North Macedonia", code: "MK"},
            {name: "Norway", code: "NO"},
            {name: "Oman", code: "OM"},
            {name: "Pakistan", code: "PK"},
            {name: "Palau", code: "PW"},
            {name: "Palestine", code: "PS"},
            {name: "Panama", code: "PA"},
            {name: "Paraguay", code: "PY"},
            {name: "Peru", code: "PE"},
            {name: "Philippines", code: "PH"},
            {name: "Poland", code: "PL"},
            {name: "Portugal", code: "PT"},
            {name: "Qatar", code: "QA"},
            {name: "Romania", code: "RO"},
            {name: "Russia", code: "RU"},
            {name: "Rwanda", code: "RW"},
            {name: "Saint Lucia", code: "LC"},
            {name: "San Marino", code: "SM"},
            {name: "Saudi Arabia", code: "SA"},
            {name: "Senegal", code: "SN"},
            {name: "Serbia", code: "RS"},
            {name: "Seychelles", code: "SC"},
            {name: "Singapore", code: "SG"},
            {name: "Slovakia", code: "SK"},
            {name: "Slovenia", code: "SI"},
            {name: "South Africa", code: "ZA"},
            {name: "South Korea", code: "KR"},
            {name: "Spain", code: "ES"},
            {name: "Sweden", code: "SE"},
            {name: "Switzerland", code: "CH"},
            {name: "Syria", code: "SY"},
            {name: "Taiwan", code: "TW"},
            {name: "Tajikistan", code: "TJ"},
            {name: "Tanzania", code: "TZ"},
            {name: "Thailand", code: "TH"},
            {name: "Togo", code: "TG"},
            {name: "Tonga", code: "TO"},
            {name: "Tunisia", code: "TN"},
            {name: "Turkey", code: "TR", aliases: ["Türkiye", "Turkiye", "TR"]},
            {name: "Turkmenistan", code: "TM"},
            {name: "Uganda", code: "UG"},
            {name: "Ukraine", code: "UA"},
            {name: "United Arab Emirates", code: "AE"},
            {name: "United Kingdom", code: "GB", aliases: ["UK", "Britain", "England"]},
            {name: "United States", code: "US", aliases: ["USA", "United States of America", "America", "US"]},
            {name: "Uruguay", code: "UY"},
            {name: "Uzbekistan", code: "UZ"},
            {name: "Vatican City", code: "VA"},
            {name: "Venezuela", code: "VE"},
            {name: "Vietnam", code: "VN"},
            {name: "Yemen", code: "YE"},
            {name: "Zambia", code: "ZM"},
            {name: "Zimbabwe", code: "ZW"}
        ].sort((a, b) => a.name.localeCompare(b.name));

        tg.CloudStorage.getItem('profile', (err, savedProfile) => {
            if (savedProfile) {
                window.location.href = '/chat';
                return;
            }

            document.getElementById('app').innerHTML = `
                <div class="header">
                    <h1 class="logo">Chatle</h1>
                    <p class="subtitle">Random anonymous chats worldwide</p>
                </div>

                <div class="profile-card">
                    <img src="${photoUrl}" alt="Profile" class="avatar">
                    <h2 class="greeting">Hello, ${displayName}</h2>
                    <p class="info">Complete your profile to start</p>
                </div>

                <div class="form-group">
                    <label>Nickname (required)</label>
                    <input type="text" id="nickname" placeholder="Choose your nickname">
                </div>

                <div class="form-group">
                    <label>Age (required)</label>
                    <input type="number" id="age" placeholder="Your age" min="13" max="99">
                </div>

                <div class="form-group">
                    <label>Gender (required)</label>
                    <select id="gender">
                        <option value="" disabled selected>Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other / Prefer not to say</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Country (required)</label>
                    <div class="country-input">
                        <input type="text" id="country-search" placeholder="Type your country..." autocomplete="off">
                        <div id="country-list"></div>
                    </div>
                    <input type="hidden" id="selected-country">
                </div>

                <div class="form-group">
                    <label>Bio (optional)</label>
                    <textarea id="bio" placeholder="Tell something about yourself..."></textarea>
                </div>
            `;

            const countrySearch = document.getElementById('country-search');
            const countryList = document.getElementById('country-list');
            const selectedCountry = document.getElementById('selected-country');

            const showCountries = (query) => {
                countryList.innerHTML = '';
                const q = query.toLowerCase().trim();

                const filtered = countries.filter(c => 
                    c.name.toLowerCase().includes(q) ||
                    c.code.toLowerCase().includes(q) ||
                    (c.aliases && c.aliases.some(a => a.toLowerCase().includes(q)))
                );

                if (filtered.length === 0 || q === '') {
                    if (q === '') filtered = countries; // focus'ta tüm liste
                    else { countryList.style.display = 'none'; return; }
                }

                filtered.forEach(country => {
                    const item = document.createElement('div');
                    item.className = 'country-item';
                    item.textContent = country.name;
                    item.onclick = () => {
                        countrySearch.value = country.name;
                        selectedCountry.value = country.code;
                        countryList.style.display = 'none';
                    };
                    countryList.appendChild(item);
                });

                countryList.style.display = 'block';
            };

            countrySearch.addEventListener('focus', () => showCountries(''));
            countrySearch.addEventListener('input', e => showCountries(e.target.value));

            document.addEventListener('click', e => {
                if (!countrySearch.contains(e.target) && !countryList.contains(e.target)) {
                    countryList.style.display = 'none';
                }
            });

            tg.MainButton.setText("Start Chatting →");
            tg.MainButton.color = '#0088cc';
            tg.MainButton.show();
            tg.MainButton.enable();

            tg.MainButton.onClick(() => {
                const nickname = document.getElementById('nickname').value.trim();
                const age = document.getElementById('age').value;
                const gender = document.getElementById('gender').value;
                const countryCode = selectedCountry.value;

                if (!nickname || !age || !gender || !countryCode) {
                    tg.showAlert("Please fill all required fields.");
                    return;
                }

                if (age < 13 || age > 99) {
                    tg.showAlert("Age must be between 13–99.");
                    return;
                }

                const profile = {
                    nickname,
                    age: parseInt(age),
                    gender,
                    country: countryCode,
                    countryName: countrySearch.value,
                    bio: document.getElementById('bio').value.trim(),
                    telegramId: user.id,
                    username: user.username || null,
                    firstName: user.first_name,
                    lastName: user.last_name || null,
                    photoUrl: user.photo_url || null,
                    savedAt: new Date().toISOString()
                };

                tg.MainButton.showProgress(true);

                tg.CloudStorage.setItem('profile', JSON.stringify(profile), (err, success) => {
                    if (success) {
                        window.location.href = '/chat';
                    } else {
                        tg.MainButton.hideProgress();
                        tg.showAlert("Save failed, try again.");
                    }
                });
            });
        });
    </script>
</body>
</html>

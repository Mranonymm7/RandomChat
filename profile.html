<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatle — Profile</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root{
    --bg:#041022; --panel:#0b1522; --muted:#93aebf; --text:#eaf6ff; --accent:#1ea7ff; --danger:#ff4b4b;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:18px}
  .card{width:100%;max-width:820px;background:var(--panel);border-radius:14px;padding:22px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  h1{font-size:20px;margin-bottom:6px}
  p.lead{color:var(--muted);margin-bottom:14px}
  .row{display:flex;gap:14px;align-items:center}
  .avatar{width:84px;height:84px;border-radius:50%;border:3px solid var(--accent);object-fit:cover;background:#08121a}
  .controls{flex:1;display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
  input[type="text"], textarea, input[type="url"], select {
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#071422;color:var(--text);font-size:14px;
  }
  textarea{min-height:96px;resize:vertical}
  .small{color:var(--muted);font-size:13px}
  .row2{display:flex;gap:10px;margin-top:8px}
  button.primary{background:linear-gradient(90deg,var(--accent),#0084ff);color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 14px;border-radius:10px;cursor:pointer}
  .danger{background:var(--danger);border:none;padding:10px 14px;border-radius:10px;color:white;cursor:pointer}
  .meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .readonly{opacity:0.9;background:transparent;border:1px dashed rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  .hint{font-size:13px;color:var(--muted);margin-top:8px}
  .footer{display:flex;gap:8px;justify-content:space-between;margin-top:16px;align-items:center}
  .inline-btn{background:transparent;border:none;color:var(--accent);cursor:pointer;font-weight:700}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:var(--panel);padding:18px;border-radius:12px;width:92%;max-width:420px}
  .modal h3{margin-bottom:8px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
</style>
</head>
<body>
  <div class="card">
    <h1>Profile</h1>
    <p class="lead">Set your display name and bio. Your age and gender are shown but cannot be changed here (you can set them once if missing).</p>

    <div class="row" style="margin-top:12px">
      <img id="avatar" class="avatar" src="" alt="avatar">
      <div class="controls">
        <div>
          <label for="nickname">Display name</label>
          <input id="nickname" type="text" maxlength="40" placeholder="Your display name">
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>Age (read-only)</label>
            <div id="ageBox" class="readonly small">—</div>
          </div>
          <div style="flex:1">
            <label>Gender (read-only)</label>
            <div id="genderBox" class="readonly small">—</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="photoUrl">Photo URL (paste an image URL) — or use your Telegram avatar</label>
          <input id="photoUrl" type="url" placeholder="https://...">
          <div class="row2">
            <button id="useTelegramAvatar" class="ghost">Use Telegram avatar</button>
            <button id="previewBtn" class="ghost">Preview</button>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <label for="bio">Bio</label>
      <textarea id="bio" maxlength="280" placeholder="Write a short bio (max 280 chars)"></textarea>
      <div class="hint">Preview below — keep it short and friendly.</div>
    </div>

    <div style="margin-top:12px">
      <div class="meta-grid">
        <div>
          <label>Preview</label>
          <div style="background:#071826;padding:12px;border-radius:10px">
            <div style="display:flex;gap:12px;align-items:center">
              <img id="previewAvatar" src="" style="width:48px;height:48px;border-radius:50%;border:2px solid var(--accent);object-fit:cover">
              <div>
                <div id="previewName" style="font-weight:700"></div>
                <div id="previewDetails" class="small"></div>
              </div>
            </div>
            <div id="previewBio" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </div>

        <div>
          <label>Quick actions</label>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="saveBtn" class="primary">Save profile</button>
            <button id="clearBtn" class="ghost">Delete profile</button>
            <div style="margin-top:6px"><button id="setAgeGenderBtn" class="ghost">Set Age & Gender (if missing)</button></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer" style="margin-top:14px">
      <div class="small">Profile stored in Telegram CloudStorage</div>
      <div>
        <button id="doneBtn" class="inline-btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Modal for setting Age/Gender once -->
  <div id="modal" class="modal-back" aria-hidden="true">
    <div class="modal">
      <h3>Set your Age & Gender</h3>
      <p class="small">You can set these only once here. After saving they become read-only on profile page.</p>

      <div style="margin-top:8px">
        <label>Age</label>
        <input id="modalAge" type="text" inputmode="numeric" placeholder="e.g. 24" maxlength="3">
      </div>
      <div style="margin-top:8px">
        <label>Gender</label>
        <select id="modalGender">
          <option value="">Select</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="actions">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalSave" class="primary">Save</button>
      </div>
    </div>
  </div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const tg = Telegram.WebApp;
const avatarEl = document.getElementById('avatar');
const nicknameEl = document.getElementById('nickname');
const photoUrlEl = document.getElementById('photoUrl');
const useTelegramAvatarBtn = document.getElementById('useTelegramAvatar');
const previewBtn = document.getElementById('previewBtn');
const previewAvatar = document.getElementById('previewAvatar');
const previewName = document.getElementById('previewName');
const previewDetails = document.getElementById('previewDetails');
const previewBio = document.getElementById('previewBio');
const bioEl = document.getElementById('bio');
const ageBox = document.getElementById('ageBox');
const genderBox = document.getElementById('genderBox');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const doneBtn = document.getElementById('doneBtn');
const setAgeGenderBtn = document.getElementById('setAgeGenderBtn');

const modal = document.getElementById('modal');
const modalAge = document.getElementById('modalAge');
const modalGender = document.getElementById('modalGender');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

let profile = null; // in-memory profile

// helper: get Telegram avatar URL if available
const initUser = Telegram.WebApp.initDataUnsafe?.user;
const telegramAvatar = initUser?.photo_url || initUser?.photoUrl || '';

// load existing profile from CloudStorage
tg.CloudStorage.getItem('profile', (err, saved) => {
  if (err) {
    console.warn("CloudStorage error:", err);
    tg.showPopup({ message: "Failed to read profile" });
    return;
  }
  if (!saved) {
    // no profile yet -> create minimal object using Telegram name/avatar
    profile = {
      nickname: initUser?.first_name || '',
      photoUrl: telegramAvatar || '',
      age: null,
      gender: '',
      country: '',
      countryName: '',
      bio: ''
    };
  } else {
    try { profile = JSON.parse(saved); } catch(e) { profile = null; }
    if (!profile) {
      profile = {
        nickname: initUser?.first_name || '',
        photoUrl: telegramAvatar || '',
        age: null,
        gender: '',
        country: '',
        countryName: '',
        bio: ''
      };
    }
  }

  // populate UI
  nicknameEl.value = profile.nickname || '';
  photoUrlEl.value = profile.photoUrl || '';
  avatarEl.src = profile.photoUrl || telegramAvatar || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
  previewAvatar.src = avatarEl.src;
  bioEl.value = profile.bio || '';
  previewName.textContent = profile.nickname || initUser?.first_name || 'User';
  previewBio.textContent = profile.bio || '';
  previewDetails.textContent = (profile.countryName || profile.country) ? `${profile.countryName || profile.country}` : '';

  ageBox.textContent = profile.age ? profile.age : '—';
  genderBox.textContent = profile.gender ? (profile.gender.charAt(0).toUpperCase() + profile.gender.slice(1)) : '—';

  // hide "Set Age & Gender" if both exist
  if (profile.age && profile.gender) {
    setAgeGenderBtn.style.display = 'none';
  }
});

// preview logic
function updatePreview(){
  const nick = nicknameEl.value.trim() || (initUser?.first_name || 'User');
  const photo = photoUrlEl.value.trim() || avatarEl.src || telegramAvatar || '';
  const bio = bioEl.value.trim();

  previewName.textContent = nick;
  previewAvatar.src = photo || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
  previewBio.textContent = bio || '';
}
nicknameEl.addEventListener('input', updatePreview);
photoUrlEl.addEventListener('input', () => {
  const url = photoUrlEl.value.trim();
  if (url) avatarEl.src = url;
  updatePreview();
});
bioEl.addEventListener('input', updatePreview);
previewBtn.addEventListener('click', updatePreview);

// use telegram avatar
useTelegramAvatarBtn.addEventListener('click', () => {
  if (!telegramAvatar) {
    tg.showPopup({ message: "Telegram avatar not available" });
    return;
  }
  photoUrlEl.value = telegramAvatar;
  avatarEl.src = telegramAvatar;
  updatePreview();
});

// Save profile -> write to Telegram CloudStorage
saveBtn.addEventListener('click', () => {
  // validation
  const nickname = nicknameEl.value.trim();
  if (!nickname) {
    tg.showPopup({ message: "Please enter a display name" });
    return;
  }
  if ((bioEl.value || '').length > 280) {
    tg.showPopup({ message: "Bio is too long (max 280 chars)" });
    return;
  }
  // keep age/gender if already set
  const finalProfile = {
    nickname,
    photoUrl: (photoUrlEl.value.trim() || avatarEl.src || telegramAvatar || ''),
    age: profile?.age || null,
    gender: profile?.gender || '',
    country: profile?.country || '',
    countryName: profile?.countryName || '',
    bio: bioEl.value.trim()
  };

  // Save to CloudStorage
  try {
    tg.CloudStorage.setItem('profile', JSON.stringify(finalProfile), (err, res) => {
      if (err) {
        console.error("CloudStorage setItem error:", err);
        tg.showPopup({ message: "Failed to save profile" });
        return;
      }
      profile = finalProfile; // update current
      ageBox.textContent = profile.age ? profile.age : '—';
      genderBox.textContent = profile.gender ? (profile.gender.charAt(0).toUpperCase() + profile.gender.slice(1)) : '—';
      setAgeGenderBtn.style.display = profile.age && profile.gender ? 'none' : 'inline-block';
      tg.showPopup({ message: "Profile saved" });
    });
  } catch(e){
    console.error("setItem exception:", e);
    tg.showPopup({ message: "Failed to save profile" });
  }
});

// Delete profile (for testing)
clearBtn.addEventListener('click', () => {
  if (!confirm("Delete stored profile from CloudStorage? This cannot be undone.")) return;
  tg.CloudStorage.removeItem('profile', (err, res) => {
    if (err) {
      console.error("removeItem error:", err);
      tg.showPopup({ message: "Failed to delete profile" });
      return;
    }
    tg.showPopup({ message: "Profile deleted. Reload to start fresh." });
    // reset UI to defaults
    nicknameEl.value = initUser?.first_name || '';
    photoUrlEl.value = telegramAvatar || '';
    avatarEl.src = telegramAvatar || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
    bioEl.value = '';
    profile = null;
    ageBox.textContent = '—';
    genderBox.textContent = '—';
    setAgeGenderBtn.style.display = 'inline-block';
    updatePreview();
  });
});

// Done button => go back to chat home
doneBtn.addEventListener('click', () => {
  window.location.href = '/chat.html';
});

// Set age & gender modal flow — only allow if missing
setAgeGenderBtn.addEventListener('click', () => {
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  modalAge.value = '';
  modalGender.value = '';
});

// modal cancel
modalCancel.addEventListener('click', () => {
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
});

// modal save — set only if not already set
modalSave.addEventListener('click', () => {
  const a = modalAge.value.trim();
  const g = modalGender.value;
  if (!a || !/^\d{1,3}$/.test(a) || Number(a) <= 0) { tg.showPopup({ message: "Please enter a valid age" }); return; }
  if (!g) { tg.showPopup({ message: "Please choose a gender" }); return; }

  // Apply to profile object and save (if profile exists, keep nickname/bio)
  const newProfile = Object.assign({}, profile || {}, {
    nickname: nicknameEl.value.trim() || initUser?.first_name || '',
    photoUrl: photoUrlEl.value.trim() || avatarEl.src || telegramAvatar || '',
    age: Number(a),
    gender: g,
    country: profile?.country || '',
    countryName: profile?.countryName || '',
    bio: bioEl.value.trim()
  });

  // Save to CloudStorage
  tg.CloudStorage.setItem('profile', JSON.stringify(newProfile), (err) => {
    if (err) {
      console.error("modal save error", err);
      tg.showPopup({ message: "Failed to save age & gender" });
      return;
    }
    profile = newProfile;
    ageBox.textContent = profile.age;
    genderBox.textContent = profile.gender.charAt(0).toUpperCase() + profile.gender.slice(1);
    setAgeGenderBtn.style.display = 'none';
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    tg.showPopup({ message: "Age & gender saved (read-only now)" });
  });
});

// small accessibility: close modal with Escape
window.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }
});
</script>
</body>
  </html>

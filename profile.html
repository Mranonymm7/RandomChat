<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatle — Profile</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root{
    --bg:#041022; --panel:#0b1522; --muted:#93aebf; --text:#eaf6ff; --accent:#1ea7ff; --danger:#ff4b4b;
    --footer-height:76px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:18px;padding-bottom:calc(var(--footer-height) + 18px);}

  .card{width:100%;max-width:820px;background:var(--panel);border-radius:14px;padding:20px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .row{display:flex;align-items:center;gap:14px}
  .avatar{width:84px;height:84px;border-radius:50%;border:3px solid var(--accent);object-fit:cover;background:#08121a}
  h1{font-size:18px;margin-bottom:6px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:12px}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type="text"], textarea, input[type="url"]{
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:#071422;color:var(--text);
  }
  textarea{min-height:88px;resize:vertical}
  .meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .field{background:transparent;padding:10px;border-radius:10px;border:1px dashed rgba(255,255,255,0.02);color:var(--text)}
  .actions{display:flex;gap:8px;margin-top:12px}
  button.primary{background:linear-gradient(90deg,var(--accent),#0084ff);color:white;border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.danger{background:var(--danger);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}

  .preview{margin-top:12px;background:#071826;padding:12px;border-radius:10px;display:flex;gap:12px;align-items:center}
  .preview .name{font-weight:700}
  .hint{color:var(--muted);font-size:13px;margin-top:8px}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:var(--panel);padding:16px;border-radius:12px;width:92%;max-width:420px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* footer nav */
  footer{
    position:fixed;left:0;right:0;bottom:0;height:var(--footer-height);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02));border-top:1px solid rgba(255,255,255,0.03);z-index:9999;
  }
  .nav{width:100%;max-width:820px;display:flex;gap:8px;padding:12px;justify-content:space-between}
  .tab{flex:1;padding:10px 6px;border-radius:12px;text-align:center;color:var(--muted);font-weight:600;cursor:pointer;-webkit-tap-highlight-color:transparent}
  .tab.active{color:white;background:linear-gradient(90deg,var(--accent),#0084ff);box-shadow:0 6px 18px rgba(30,167,255,0.12)}
</style>
</head>
<body>
  <div class="card" role="main">
    <h1>Profile</h1>
    <div class="sub">Edit name & bio</div>

    <div class="row">
      <img id="avatar" class="avatar" src="" alt="avatar">
      <div style="flex:1">
        <label for="nickname">Display name</label>
        <input id="nickname" type="text" maxlength="40" placeholder="Your name">

        <div class="meta-grid" style="margin-top:10px">
          <div>
            <label>Age</label>
            <div id="ageField" class="field">—</div>
          </div>
          <div>
            <label>Gender</label>
            <div id="genderField" class="field">—</div>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label for="photoUrl">Photo URL</label>
      <input id="photoUrl" type="url" placeholder="https://... (optional)">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="useTelegramAvatar" class="ghost">Use Telegram avatar</button>
        <button id="previewBtn" class="ghost">Preview</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label for="bio">Bio</label>
      <textarea id="bio" maxlength="280" placeholder="Short bio"></textarea>
    </div>

    <div class="preview" aria-hidden="false" style="margin-top:12px">
      <img id="previewAvatar" src="" style="width:52px;height:52px;border-radius:50%;border:2px solid var(--accent);object-fit:cover">
      <div>
        <div id="previewName" class="name">User</div>
        <div id="previewDetails" class="hint"></div>
        <div id="previewBio" style="margin-top:6px;color:var(--muted);font-size:13px"></div>
      </div>
    </div>

    <div class="actions" style="margin-top:14px">
      <button id="saveBtn" class="primary">Save</button>
      <button id="setAgeGenderBtn" class="ghost">Set Age & Gender</button>
      <button id="clearBtn" class="ghost">Delete</button>
    </div>

    <div class="hint" style="margin-top:12px">Profile saved to Telegram CloudStorage</div>
  </div>

  <!-- modal to set age/gender once -->
  <div id="modal" class="modal-back" aria-hidden="true">
    <div class="modal">
      <div style="font-weight:700;margin-bottom:6px">Set Age & Gender</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:10px">You can set these once.</div>
      <div>
        <label>Age</label>
        <input id="modalAge" type="text" inputmode="numeric" maxlength="3" placeholder="e.g. 24">
      </div>
      <div style="margin-top:8px">
        <label>Gender</label>
        <select id="modalGender">
          <option value="">Select</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalSave" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- footer nav -->
  <footer>
    <div class="nav" role="navigation">
      <div id="tabHome" class="tab" data-href="/chat.html">Home</div>
      <div id="tabChats" class="tab" data-href="/chats.html">Chats</div>
      <div id="tabProfile" class="tab active" data-href="/profile.html">Profile</div>
      <div id="tabDiscover" class="tab" data-href="/discover.html">Discover</div>
    </div>
  </footer>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const tg = Telegram.WebApp;
const initUser = tg.initDataUnsafe?.user || {};
const telegramAvatar = initUser.photo_url || initUser.photoUrl || '';

// elements
const avatarEl = document.getElementById('avatar');
const nicknameEl = document.getElementById('nickname');
const photoUrlEl = document.getElementById('photoUrl');
const useTelegramAvatarBtn = document.getElementById('useTelegramAvatar');
const previewBtn = document.getElementById('previewBtn');
const previewAvatar = document.getElementById('previewAvatar');
const previewName = document.getElementById('previewName');
const previewDetails = document.getElementById('previewDetails');
const previewBio = document.getElementById('previewBio');
const bioEl = document.getElementById('bio');
const ageField = document.getElementById('ageField');
const genderField = document.getElementById('genderField');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const setAgeGenderBtn = document.getElementById('setAgeGenderBtn');

const modal = document.getElementById('modal');
const modalAge = document.getElementById('modalAge');
const modalGender = document.getElementById('modalGender');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

let profile = null;

// load profile from CloudStorage
tg.CloudStorage.getItem('profile', (err, saved) => {
  let p;
  try { p = saved ? JSON.parse(saved) : null; } catch(e){ p = null; }
  profile = p || {
    nickname: initUser.first_name || '',
    photoUrl: telegramAvatar || '',
    age: null,
    gender: '',
    country: '',
    countryName: '',
    bio: ''
  };

  // populate
  nicknameEl.value = profile.nickname || '';
  photoUrlEl.value = profile.photoUrl || '';
  avatarEl.src = profile.photoUrl || telegramAvatar || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
  previewAvatar.src = avatarEl.src;
  bioEl.value = profile.bio || '';
  previewName.textContent = profile.nickname || initUser.first_name || 'User';
  previewBio.textContent = profile.bio || '';
  previewDetails.textContent = (profile.countryName || profile.country) ? (profile.countryName || profile.country) : '';
  ageField.textContent = profile.age ? profile.age : '—';
  genderField.textContent = profile.gender ? (profile.gender.charAt(0).toUpperCase() + profile.gender.slice(1)) : '—';

  if (profile.age && profile.gender) {
    setAgeGenderBtn.style.display = 'none';
  }
});

// preview update
function updatePreview(){
  const nick = nicknameEl.value.trim() || initUser.first_name || 'User';
  const photo = photoUrlEl.value.trim() || avatarEl.src || telegramAvatar || '';
  const bio = bioEl.value.trim();

  previewName.textContent = nick;
  previewAvatar.src = photo || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
  previewBio.textContent = bio || '';
}
nicknameEl.addEventListener('input', updatePreview);
photoUrlEl.addEventListener('input', () => { avatarEl.src = photoUrlEl.value.trim() || avatarEl.src; updatePreview(); });
bioEl.addEventListener('input', updatePreview);
previewBtn.addEventListener('click', updatePreview);

// use telegram avatar
useTelegramAvatarBtn.addEventListener('click', () => {
  if (!telegramAvatar) { tg.showPopup({message:"Telegram avatar not available"}); return; }
  photoUrlEl.value = telegramAvatar;
  avatarEl.src = telegramAvatar;
  updatePreview();
});

// Save profile
saveBtn.addEventListener('click', () => {
  const nickname = nicknameEl.value.trim();
  if (!nickname) { tg.showPopup({message:"Please enter a name"}); return; }
  const newProfile = {
    nickname,
    photoUrl: photoUrlEl.value.trim() || avatarEl.src || telegramAvatar || '',
    age: profile?.age || null,
    gender: profile?.gender || '',
    country: profile?.country || '',
    countryName: profile?.countryName || '',
    bio: bioEl.value.trim()
  };
  tg.CloudStorage.setItem('profile', JSON.stringify(newProfile), (err) => {
    if (err) { console.error("save profile err", err); tg.showPopup({message:"Save failed"}); return; }
    profile = newProfile;
    ageField.textContent = profile.age ? profile.age : '—';
    genderField.textContent = profile.gender ? (profile.gender.charAt(0).toUpperCase()+profile.gender.slice(1)) : '—';
    if (profile.age && profile.gender) setAgeGenderBtn.style.display = 'none';
    tg.showPopup({message:"Saved"});
  });
});

// Delete profile
clearBtn.addEventListener('click', () => {
  if (!confirm("Delete profile?")) return;
  tg.CloudStorage.removeItem('profile', (err) => {
    if (err) { console.error("delete err", err); tg.showPopup({message:"Delete failed"}); return; }
    profile = { nickname: initUser.first_name || '', photoUrl: telegramAvatar || '', age: null, gender: '', country: '', countryName: '', bio: '' };
    nicknameEl.value = profile.nickname;
    photoUrlEl.value = profile.photoUrl;
    avatarEl.src = profile.photoUrl || telegramAvatar || 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f60a.png';
    previewAvatar.src = avatarEl.src;
    bioEl.value = '';
    ageField.textContent = '—';
    genderField.textContent = '—';
    setAgeGenderBtn.style.display = 'inline-block';
    tg.showPopup({message:"Deleted"});
  });
});

// Set age & gender modal
setAgeGenderBtn.addEventListener('click', () => {
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  modalAge.value = '';
  modalGender.value = '';
});
modalCancel.addEventListener('click', () => {
  modal.style.display = 'none'; modal.setAttribute('aria-hidden','true');
});
modalSave.addEventListener('click', () => {
  const a = modalAge.value.trim();
  const g = modalGender.value;
  if (!a || !/^\d{1,3}$/.test(a) || Number(a) <= 0) { tg.showPopup({message:"Enter a valid age"}); return; }
  if (!g) { tg.showPopup({message:"Choose a gender"}); return; }

  const newProfile = Object.assign({}, profile || {}, {
    nickname: nicknameEl.value.trim() || initUser.first_name || '',
    photoUrl: photoUrlEl.value.trim() || avatarEl.src || telegramAvatar || '',
    age: Number(a),
    gender: g,
    bio: bioEl.value.trim()
  });

  tg.CloudStorage.setItem('profile', JSON.stringify(newProfile), (err) => {
    if (err) { console.error("modal save err", err); tg.showPopup({message:"Save failed"}); return; }
    profile = newProfile;
    ageField.textContent = profile.age;
    genderField.textContent = profile.gender.charAt(0).toUpperCase() + profile.gender.slice(1);
    setAgeGenderBtn.style.display = 'none';
    modal.style.display = 'none'; modal.setAttribute('aria-hidden','true');
    tg.showPopup({message:"Saved"});
  });
});

// footer nav behavior
const tabs = Array.from(document.querySelectorAll('.tab'));
tabs.forEach(el => {
  el.addEventListener('click', () => {
    const href = el.getAttribute('data-href');
    try {
      window.location.href = href;
    } catch(e) {
      console.error("nav error", e);
      tg.showPopup({message:"Navigation failed"});
    }
  });
});

// keyboard accessibility
tabs.forEach(el=>{ el.setAttribute('tabindex','0'); el.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') el.click(); }) });

</script>
</body>
</html>
